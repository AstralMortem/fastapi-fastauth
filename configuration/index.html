
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Ready-to-use customizable solution for FastAPI with Authentication, Authorization(RBAC) and OAuth2 support">
      
      
        <meta name="author" content="chaliukvladyslav@gmail.com (Vladyslav Chaliuk)">
      
      
      
        <link rel="prev" href="../installation/">
      
      
        <link rel="next" href="../how_to_use/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Configuration - FastAuth</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#configuration" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="FastAuth" class="md-header__button md-logo" aria-label="FastAuth" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m10 17-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9m-6-8L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FastAuth
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Configuration
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="green"  aria-label="Switch to dark theme"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark theme" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="deep-purple"  aria-label="Switch to light theme"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light theme" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/AstralMortem/fastapi-fastauth" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    AstralMortem/fastapi-fastauth
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href=".." class="md-tabs__link">
          
  
  
    
  
  FastAuth

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="FastAuth" class="md-nav__button md-logo" aria-label="FastAuth" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m10 17-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9m-6-8L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5z"/></svg>

    </a>
    FastAuth
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/AstralMortem/fastapi-fastauth" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    AstralMortem/fastapi-fastauth
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href=".." class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    FastAuth
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            FastAuth
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#models" class="md-nav__link">
    <span class="md-ellipsis">
      Models
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#repositories" class="md-nav__link">
    <span class="md-ellipsis">
      Repositories
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#token-storage" class="md-nav__link">
    <span class="md-ellipsis">
      Token Storage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    <span class="md-ellipsis">
      Services
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transport" class="md-nav__link">
    <span class="md-ellipsis">
      Transport
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fastauth" class="md-nav__link">
    <span class="md-ellipsis">
      FastAuth
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#full-sqlalchemy-example" class="md-nav__link">
    <span class="md-ellipsis">
      Full SQLAlchemy Example
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how_to_use/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    How To Use
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/AstralMortem/fastapi-fastauth/edit/master/docs/configuration.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/AstralMortem/fastapi-fastauth/raw/master/docs/configuration.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<h1 id="configuration">Configuration</h1>
<p>First you need to choose orm provider, for this examples we will use SQLAlchemy, and init <code>FastAuthSettings</code> class.
Let`s init configuration, which we use later.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAuthSettings</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">FastAuthSettings</span><span class="p">()</span>
</code></pre></div>
<p>There we can share some variables across classes inside library. Also we can extend or override config variables, for example by direct change, or inherit class.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAuthSettings</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">(</span><span class="n">FastAuthSettings</span><span class="p">):</span>
    <span class="c1"># Override flag to allow inactive users to login</span>
    <span class="n">ALLOW_INACTIVE_USERS</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span> 
</code></pre></div>
<h2 id="models">Models</h2>
<p>First of all, we need to create tables inside DB, so let`s implement ORM Models class.
FastAuth support sqlalchemy out-the-box, so we just need to inherit ready to use mixins</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span><span class="p">,</span> <span class="n">Mapped</span><span class="p">,</span> <span class="n">mapped_column</span><span class="p">,</span> <span class="n">relationship</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.contrib.sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseUUIDUserModel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseUUIDUserModel</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Another ID field</p>
<p>You can customize User ID field, you need to inherit <code>BaseUserModel[ID]</code> class, and set <code>id</code> field
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.contrib.sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseUserModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span><span class="p">,</span> <span class="n">mapped_column</span>

<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseUserModel</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></p>
</div>
<p>Now we have <code>User</code> model. But if you want add support of RBAC, you need to create <code>Role</code> and <code>Permission</code> models.
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.contrib.sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseIntRoleModel</span><span class="p">,</span> <span class="n">BaseIntPermissionModel</span><span class="p">,</span> <span class="n">BaseRolePermissionRel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Permission</span><span class="p">(</span><span class="n">BaseIntPermissionModel</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Role</span><span class="p">(</span><span class="n">BaseIntRoleModel</span><span class="p">[</span><span class="n">Permission</span><span class="p">],</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">permisions</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Permission</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;selectin&#39;</span><span class="p">)</span>


<span class="c1"># Need for sqlalchemy, to indentify many-to-many table</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RolePermissionRel</span><span class="p">(</span><span class="n">BaseRolePermissionRel</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Base</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></p>
<p>Then we need to upgrade our <code>User</code> model and add connection between roles and users tables
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.contrib.sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseUUIDUserModel</span><span class="p">,</span> <span class="n">RBACMixin</span><span class="p">,</span> <span class="n">BaseUserRoleRel</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseUUIDUserModel</span><span class="p">,</span><span class="n">RBACMixin</span><span class="p">[</span><span class="n">Role</span><span class="p">],</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">roles</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Role</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">lazy</span><span class="o">=</span><span class="s2">&quot;selectin&quot;</span><span class="p">)</span>


<span class="c1"># Need for sqlalchemy, to indentify many-to-many table</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserRoleRel</span><span class="p">(</span><span class="n">BaseUserRoleRel</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Base</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></p>
<div class="admonition tip">
<p class="admonition-title">Role and Permission ID field</p>
<p>As for <code>User</code> model, you can also customize <code>Role</code> and <code>Permission</code> id field, by inherit <code>BaseRoleModel</code> and <code>BasePermissionModel</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.contrib.sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseRoleModel</span><span class="p">,</span> <span class="n">BasePermissionModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span><span class="p">,</span> <span class="n">mapped_column</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Role</span><span class="p">(</span><span class="n">BaseRoleModel</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">]):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Permission</span><span class="p">(</span><span class="n">BasePermissionModel</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">]):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">)</span>
</code></pre></div>
</div>
<p>For OAuth support, we need create proper model too.
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.contrib.sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseUUIDOAuthAccount</span>

<span class="k">class</span><span class="w"> </span><span class="nc">OAuthAccount</span><span class="p">(</span><span class="n">BaseUUIDOAuthAccount</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></p>
<div class="admonition tip">
<p class="admonition-title">OAuth ID Field</p>
<p>There is we can customize ID field to, just inherit <code>BaseOAuthModel</code> class</p>
</div>
<p>After, we need to update <code>User</code> Model, and add proper lazy select for field</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.contrib.sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseUUIDUserModel</span><span class="p">,</span> <span class="n">RBACMixin</span><span class="p">,</span> <span class="n">OAuthMixin</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseUUIDUserModel</span><span class="p">,</span><span class="n">RBACMixin</span><span class="p">[</span><span class="n">Role</span><span class="p">],</span> <span class="n">OAuthMixin</span><span class="p">[</span><span class="n">OAuthAccount</span><span class="p">],</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">roles</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Role</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">lazy</span><span class="o">=</span><span class="s2">&quot;selectin&quot;</span><span class="p">)</span>
    <span class="n">oauth_accounts</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">OAuthAccount</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">lazy</span><span class="o">=</span><span class="s2">&quot;joined&quot;</span><span class="p">)</span>
</code></pre></div>
<h2 id="repositories">Repositories</h2>
<p>To make the library as extensible as possible, we chose the Service-Repository architecture.
So we need to implement repository class for every ORM Model.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.repositories</span><span class="w"> </span><span class="kn">import</span> <span class="n">IRoleRepository</span><span class="p">,</span> <span class="n">IUserRepository</span><span class="p">,</span> <span class="n">IOAuthRepository</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.contrib.sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">SQLAlchemyUserRepository</span><span class="p">,</span>
    <span class="n">SQLAlchemyOAuthRepository</span><span class="p">,</span>
    <span class="n">SQLAlchemyRoleRepository</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>



<span class="k">class</span><span class="w"> </span><span class="nc">UserRepository</span><span class="p">(</span><span class="n">SQLAlchemyUserRepository</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">]):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RoleRepository</span><span class="p">(</span><span class="n">SQLAlchemyRoleRepository</span><span class="p">[</span><span class="n">Role</span><span class="p">,</span> <span class="nb">int</span><span class="p">]):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Role</span>


<span class="k">class</span><span class="w"> </span><span class="nc">OAuthRepository</span><span class="p">(</span><span class="n">SQLAlchemyOAuthRepository</span><span class="p">[</span><span class="n">OAuthAccount</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">User</span><span class="p">]):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">OAuthAccount</span>
    <span class="n">user_model</span> <span class="o">=</span> <span class="n">User</span>
</code></pre></div>
<p>Inside this classes we can override methods to get items from DB.
After creation repos, we need to create dependencies, by using FastAPI Depends function, this is very simple.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_repository</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">SessionDep</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_oauth_repository</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">SessionDep</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">OAuthRepository</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_role_repository</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">SessionDep</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">RoleRepository</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>


<span class="n">UserRepoDep</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">IUserRepository</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_user_repository</span><span class="p">)]</span>
<span class="n">OAuthRepoDep</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">IOAuthRepository</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_oauth_repository</span><span class="p">)]</span>
<span class="n">RoleRepoDep</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">IRoleRepository</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_role_repository</span><span class="p">)]</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">SessionDep</p>
<p><code>SessionDep</code> is just annotation for sqlalchemy async session generator
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_async_engine</span><span class="p">,</span> <span class="n">async_sessionmaker</span><span class="p">,</span> <span class="n">AsyncSession</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span><span class="s2">&quot;&lt;DATABASE_URL&gt;&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">session_factory</span> <span class="o">=</span> <span class="n">async_sessionmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_session</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">session_factory</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">session</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="n">SessionDep</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">AsyncSession</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_session</span><span class="p">)]</span>
</code></pre></div></p>
</div>
<h2 id="token-storage">Token Storage</h2>
<p>For user authentication, we need to use tokens. Tokens should be stored somewhere or have a mechanism for verifying authenticity.
For this features we use <code>BaseTokenStorage</code> class, which handle how and where store tokens. The most simple token storage is jwt, because we do not need to use DB
or Redis to store it physicaly. To work with JWT we need to make dependencies with <code>JWTTokenStorage</code> class</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">JWTTokenStorage</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_auth_storage</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">JWTTokenStorage</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</code></pre></div>
<h2 id="services">Services</h2>
<p>After creating repositories and token storage, we need to implement AuthService class, which handle all business login such as login, token creation, etc.
Inside class we can override some events, such as <code>on_after_register</code>, <code>on_after_delete</code>, etc.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.services</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseAuthService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AuthService</span><span class="p">(</span><span class="n">BaseAuthService</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_auth_service</span><span class="p">(</span>
    <span class="n">user_repo</span><span class="p">:</span> <span class="n">UserRepoDep</span><span class="p">,</span>
    <span class="n">oauth_repo</span><span class="p">:</span> <span class="n">OAuthRepoDep</span><span class="p">,</span>
    <span class="n">role_repo</span><span class="p">:</span> <span class="n">RoleRepoDep</span><span class="p">,</span>
    <span class="n">token_storage</span><span class="p">:</span> <span class="n">JWTTokenStorage</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_token_storage</span><span class="p">),</span>
<span class="p">):</span>
    <span class="k">return</span> <span class="n">AuthService</span><span class="p">(</span>
        <span class="n">settings</span><span class="p">,</span> <span class="n">user_repo</span><span class="p">,</span> <span class="n">token_storage</span><span class="p">,</span> <span class="n">oauth_repo</span><span class="o">=</span><span class="n">oauth_repo</span><span class="p">,</span> <span class="n">role_repo</span><span class="o">=</span><span class="n">role_repo</span>
    <span class="p">)</span>


<span class="n">AuthServiceDep</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">AuthService</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_auth_service</span><span class="p">)]</span>
</code></pre></div>
<h2 id="transport">Transport</h2>
<p>We need choose throught which transport we get tokens from user in request, it can be Bearer in header or cookie token. To handle this we use <code>BaseTransport</code> class.
For example we will use <code>CookieTransport</code> which handle token recieve throught cookies.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.transport</span><span class="w"> </span><span class="kn">import</span> <span class="n">CookieTransport</span>

<span class="n">transport</span> <span class="o">=</span> <span class="n">CookieTransport</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</code></pre></div>
<h2 id="fastauth">FastAuth</h2>
<p>Last class which Facade for everything is <code>FastAuth</code> class. It checks the validity of tokens and whether the user has access to the resource.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastauth</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAuth</span>

<span class="n">security</span> <span class="o">=</span> <span class="n">FastAuth</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">get_auth_service</span><span class="p">,</span> <span class="n">transport</span><span class="p">)</span>
</code></pre></div>
<h2 id="full-sqlalchemy-example">Full SQLAlchemy Example</h2>
<div class="tabbed-set tabbed-alternate" data-tabs="1:6"><input checked="checked" id="configpy" name="__tabbed_1" type="radio" /><input id="modelspy" name="__tabbed_1" type="radio" /><input id="dbpy" name="__tabbed_1" type="radio" /><input id="repositoriespy" name="__tabbed_1" type="radio" /><input id="servicespy" name="__tabbed_1" type="radio" /><input id="securitypy" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="configpy">config.py</label><label for="modelspy">models.py</label><label for="dbpy">db.py</label><label for="repositoriespy">repositories.py</label><label for="servicespy">services.py</label><label for="securitypy">security.py</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAuthSettings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic_settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseSettingsModel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">(</span><span class="n">FastAuthSettings</span><span class="p">,</span> <span class="n">BaseSettingsModel</span><span class="p">):</span>
    <span class="n">DATABASE_URL</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;DATABASE_URL&quot;</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.contrib.sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseIntRoleModel</span><span class="p">,</span> <span class="n">BaseIntPermissionModel</span><span class="p">,</span> <span class="n">BaseRolePermissionRel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Permission</span><span class="p">(</span><span class="n">BaseIntPermissionModel</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Role</span><span class="p">(</span><span class="n">BaseIntRoleModel</span><span class="p">[</span><span class="n">Permission</span><span class="p">],</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">permisions</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Permission</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;selectin&#39;</span><span class="p">)</span>


<span class="c1"># Need for sqlalchemy, to indentify many-to-many table</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RolePermissionRel</span><span class="p">(</span><span class="n">BaseRolePermissionRel</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Base</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.contrib.sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseUUIDOAuthAccount</span>

<span class="k">class</span><span class="w"> </span><span class="nc">OAuthAccount</span><span class="p">(</span><span class="n">BaseUUIDOAuthAccount</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.contrib.sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseUUIDUserModel</span><span class="p">,</span> <span class="n">RBACMixin</span><span class="p">,</span> <span class="n">OAuthMixin</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseUUIDUserModel</span><span class="p">,</span><span class="n">RBACMixin</span><span class="p">[</span><span class="n">Role</span><span class="p">],</span> <span class="n">OAuthMixin</span><span class="p">[</span><span class="n">OAuthAccount</span><span class="p">],</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">roles</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Role</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">lazy</span><span class="o">=</span><span class="s2">&quot;selectin&quot;</span><span class="p">)</span>
    <span class="n">oauth_accounts</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">OAuthAccount</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">lazy</span><span class="o">=</span><span class="s2">&quot;joined&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_async_engine</span><span class="p">,</span> <span class="n">async_sessionmaker</span><span class="p">,</span> <span class="n">AsyncSession</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DATABASE_URL</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">session_factory</span> <span class="o">=</span> <span class="n">async_sessionmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_session</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">session_factory</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">session</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="n">SessionDep</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">AsyncSession</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_session</span><span class="p">)]</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">SessionDep</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span><span class="p">,</span> <span class="n">Permission</span><span class="p">,</span> <span class="n">OAuthAccount</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.repositories</span><span class="w"> </span><span class="kn">import</span> <span class="n">IRoleRepository</span><span class="p">,</span> <span class="n">IUserRepository</span><span class="p">,</span> <span class="n">IOAuthRepository</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.contrib.sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">SQLAlchemyUserRepository</span><span class="p">,</span>
    <span class="n">SQLAlchemyOAuthRepository</span><span class="p">,</span>
    <span class="n">SQLAlchemyRoleRepository</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>



<span class="k">class</span><span class="w"> </span><span class="nc">UserRepository</span><span class="p">(</span><span class="n">SQLAlchemyUserRepository</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">]):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RoleRepository</span><span class="p">(</span><span class="n">SQLAlchemyRoleRepository</span><span class="p">[</span><span class="n">Role</span><span class="p">,</span> <span class="nb">int</span><span class="p">]):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Role</span>


<span class="k">class</span><span class="w"> </span><span class="nc">OAuthRepository</span><span class="p">(</span><span class="n">SQLAlchemyOAuthRepository</span><span class="p">[</span><span class="n">OAuthAccount</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">User</span><span class="p">]):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">OAuthAccount</span>
    <span class="n">user_model</span> <span class="o">=</span> <span class="n">User</span>


<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_repository</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">SessionDep</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_oauth_repository</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">SessionDep</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">OAuthRepository</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_role_repository</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">SessionDep</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">RoleRepository</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>


<span class="n">UserRepoDep</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">IUserRepository</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_user_repository</span><span class="p">)]</span>
<span class="n">OAuthRepoDep</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">IOAuthRepository</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_oauth_repository</span><span class="p">)]</span>
<span class="n">RoleRepoDep</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">IRoleRepository</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_role_repository</span><span class="p">)]</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.repositories</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserRepoDep</span><span class="p">,</span> <span class="n">OAuthRepoDep</span><span class="p">,</span> <span class="n">RoleRepoDep</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">JWTTokenStorage</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_auth_storage</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">JWTTokenStorage</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.services</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseAuthService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AuthService</span><span class="p">(</span><span class="n">BaseAuthService</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_auth_service</span><span class="p">(</span>
    <span class="n">user_repo</span><span class="p">:</span> <span class="n">UserRepoDep</span><span class="p">,</span>
    <span class="n">oauth_repo</span><span class="p">:</span> <span class="n">OAuthRepoDep</span><span class="p">,</span>
    <span class="n">role_repo</span><span class="p">:</span> <span class="n">RoleRepoDep</span><span class="p">,</span>
    <span class="n">token_storage</span><span class="p">:</span> <span class="n">JWTTokenStorage</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_token_storage</span><span class="p">),</span>
<span class="p">):</span>
    <span class="k">return</span> <span class="n">AuthService</span><span class="p">(</span>
        <span class="n">settings</span><span class="p">,</span> <span class="n">user_repo</span><span class="p">,</span> <span class="n">token_storage</span><span class="p">,</span> <span class="n">oauth_repo</span><span class="o">=</span><span class="n">oauth_repo</span><span class="p">,</span> <span class="n">role_repo</span><span class="o">=</span><span class="n">role_repo</span>
    <span class="p">)</span>


<span class="n">AuthServiceDep</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">AuthService</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_auth_service</span><span class="p">)]</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.services</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_auth_service</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastauth.transport</span><span class="w"> </span><span class="kn">import</span> <span class="n">CookieTransport</span>

<span class="n">transport</span> <span class="o">=</span> <span class="n">CookieTransport</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
<span class="n">security</span> <span class="o">=</span> <span class="n">FastAuth</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">get_auth_service</span><span class="p">,</span> <span class="n">transport</span><span class="p">)</span>
</code></pre></div>
</div>
</div>
</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../installation/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Installation">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Installation
              </div>
            </div>
          </a>
        
        
          
          <a href="../how_to_use/" class="md-footer__link md-footer__link--next" aria-label="Next: How To Use">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                How To Use
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright (c) 2025 to present Vladyslav Chaliuk and individual contributors
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.indexes", "navigation.path", "content.code.annotate", "content.code.select", "content.action.edit", "content.action.view", "content.code.copy", "content.tabs.link", "content.tooltips", "navigation.footer", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>